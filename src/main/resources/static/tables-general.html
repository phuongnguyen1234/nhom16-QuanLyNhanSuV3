<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bảng Chấm Công</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0-alpha1/css/bootstrap.min.css">
  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700|Poppins:300,400,500,600,700" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <!-- SheetJS library for exporting to Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    .table-container {
      overflow-x: auto; /* Allows horizontal scrolling if table is too wide */
      padding: 0 15px; /* Optional: Adjust padding as needed */
      margin-bottom: 20px; /* Space below the table */
    }

    .table {
      width: 100%; /* Ensures table takes full width of its container */
      max-width: 100%; /* Prevents table from exceeding container width */
      border-collapse: collapse; /* Makes table borders appear as a single border */
    }

    /* Apply custom styling for table headers and cells */
    .table th, .table td {
      white-space: nowrap; /* Prevents text from wrapping */
      overflow: hidden; /* Hides overflow text */
      text-overflow: ellipsis; /* Adds "..." for long text */
      padding: 8px 12px; /* Padding for table cells */
      vertical-align: middle; /* Aligns cell content vertically in the middle */
      word-break: break-word; /* Wraps long words to prevent overflow */
    }

    /* Optional: Style action buttons in the action column */
    .table .action-btns button {
      margin: 0 5px; /* Adds space between buttons */
      display: inline-block;
    }

    .action-btns button.btn-secondary {
      color: #555; /* Example color for secondary button */
    }

    .action-btns button.btn-primary {
      color: #007bff; /* Example color for primary button */
    }

    /* Optional: Styling for the header row */
    .table thead th {
      background-color: #f8f9fa; /* Light gray background for headers */
      color: #333; /* Dark text color for headers */
      font-weight: bold;
    }
  </style>
</head>

<body>
<!-- Header -->
<header id="header" class="header fixed-top d-flex align-items-center">
  <div class="d-flex align-items-center justify-content-between">
    <a href="index.html" class="logo d-flex align-items-center">
      <img src="assets/img/logo.png" alt="">
      <span class="d-none d-lg-block">Nhóm 16</span>
    </a>
    <i class="bi bi-list toggle-sidebar-btn"></i>
  </div>

  <div class="search-bar">
    <form class="search-form d-flex align-items-center" method="POST" action="#">
      <input type="text" name="query" placeholder="Search" title="Enter search keyword">
      <button type="submit" title="Search"><i class="bi bi-search"></i></button>
    </form>
  </div>

  <nav class="header-nav ms-auto">
    <ul class="d-flex align-items-center">
      <li class="nav-item d-block d-lg-none">
        <a class="nav-link nav-icon search-bar-toggle " href="#">
          <i class="bi bi-search"></i>
        </a>
      </li>

      <li class="nav-item dropdown pe-3">
        <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
          <img src="assets/img/profile-img.jpg" alt="Profile" class="rounded-circle">
          <span class="d-none d-md-block dropdown-toggle ps-2">Admin</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
          <li class="dropdown-header">
            <h6>Admin</h6>
            <span>Web Designer</span>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
              <i class="bi bi-person"></i>
              <span>Hồ sơ của tôi</span>
            </a>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
              <i class="bi bi-gear"></i>
              <span>Cài đặt tài khoản</span>
            </a>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item d-flex align-items-center" href="#">
              <i class="bi bi-box-arrow-right"></i>
              <span>Đăng xuất</span>
            </a>
          </li>
        </ul>
      </li>
    </ul>
  </nav>
</header>

<!-- Sidebar -->
<aside id="sidebar" class="sidebar">
  <ul class="sidebar-nav" id="sidebar-nav">
    <li class="nav-item">
      <a class="nav-link " href="index.html">
        <i class="bi bi-grid"></i>
        <span>Dashboard</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="profile-management.html">
        <i class="bi bi-folder"></i><span>Quản lý Hồ sơ</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="tables-general.html">
        <i class="bi bi-layout-text-window-reverse"></i><span>Bảng chấm công</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="tables-data.html">
        <i class="bi bi-layout-text-window-reverse"></i><span>Bảng lương</span>
      </a>
    </li>
    <li class="nav-heading">Trang</li>
    <li class="nav-item">
      <a class="nav-link " href="users-profile.html">
        <i class="bi bi-person"></i>
        <span>Hồ sơ</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link collapsed" href="pages-login.html">
        <i class="bi bi-box-arrow-in-right"></i>
        <span>Đăng nhập</span>
      </a>
    </li>
  </ul>
</aside>

<!-- Main content -->
<main id="main" class="main">
  <div class="pagetitle">
    <h1>Bảng Chấm Công</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
        <li class="breadcrumb-item active">Bảng chấm công</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Danh sách chấm công</h5>
            <div class="mb-3">
              <!-- Update the button to call the new function -->
              <button class="btn btn-primary" onclick="createAttendanceSheet()">Tạo bảng chấm công tháng này</button>
              <button class="btn btn-primary" onclick="downloadExcel()">Xuất Excel</button>
              <label for="selectMonth" class="ms-3">Thời gian:</label>
              <select id="selectMonth" class="form-select d-inline-block w-auto ms-1">
                <option selected>- Chọn tháng -</option>
                <option value="1">Tháng 1</option>
                <option value="2">Tháng 2</option>
                <option value="3">Tháng 3</option>
                <option value="4">Tháng 4</option>
                <option value="5">Tháng 5</option>
                <option value="6">Tháng 6</option>
                <option value="7">Tháng 7</option>
                <option value="8">Tháng 8</option>
                <option value="9">Tháng 9</option>
                <option value="10">Tháng 10</option>
                <option value="11">Tháng 11</option>
                <option value="12">Tháng 12</option>
                <!-- Continue for other months -->
              </select>
              <select id="selectYear" class="form-select d-inline-block w-auto ms-1">
                <option selected>- Chọn năm -</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
              </select>
            </div>

            <div class="table-container">
              <table class="table table-striped table-bordered" id="attendanceTable">
                <thead>
                <tr>
                  <th>Mã bảng chấm công</th>
                  <th>Mã nhân sự</th>
                  <th>Thời gian</th>
                  <th>Số ngày làm trong tháng</th>
                  <th>Số giờ làm thêm</th>
                  <th>Số ngày nghỉ có phép</th>
                  <th>Số ngày nghỉ không phép</th>
                  <th>Ghi chú</th>
<!--                  <th>Hành động</th>-->
                </tr>
                </thead>
                <tbody>
                <!-- Table rows go here -->
                  <tr>

                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

<!-- Vendor JS Files -->
<script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="assets/vendor/chart.js/chart.umd.js"></script>
<script src="assets/vendor/echarts/echarts.min.js"></script>
<script src="assets/vendor/quill/quill.js"></script>
<script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
<script src="assets/vendor/tinymce/tinymce.min.js"></script>
<script src="assets/vendor/php-email-form/validate.js"></script>

<!-- Template Main JS File -->
<script src="assets/js/main.js"></script>
<script>
  let selectedRow = null; // Variable to store the selected row

// Khi giá trị của tháng hoặc năm thay đổi, gọi hàm lọc
$('#selectMonth, #selectYear').on('change', function () {
    filterTableByDate(); // Gọi hàm lọc khi giá trị thay đổi
});

// Hàm lọc bảng theo tháng và năm
function filterTableByDate() {
    const selectedMonth = $('#selectMonth').val(); // Lấy giá trị tháng
    const selectedYear = $('#selectYear').val(); // Lấy giá trị năm

    // Nếu không có tháng và năm được chọn (tức là chọn "tất cả" hoặc không chọn gì)
    if (!selectedMonth || !selectedYear) {
        // Gửi yêu cầu tới API để lấy tất cả dữ liệu bảng chấm công
        $.ajax({
            url: '/api/bangchamcong/all', // Đường dẫn đến API để lấy tất cả dữ liệu
            type: 'GET',
            success: function (data) {
                if (data.length > 0) {
                    renderTable(data); // Hiển thị bảng với dữ liệu trả về
                } else {
                    const tableBody = document.querySelector('#attendanceTable tbody');
                    tableBody.innerHTML = '<tr><td colspan="10">Không có dữ liệu chấm công.</td></tr>';
                }
            },
            error: function (xhr, status, error) {
                console.error('Error fetching attendance data:', error);
                alert('Có lỗi xảy ra khi lấy dữ liệu.');
            }
        });
    } else {
        // Gửi yêu cầu tới API để lọc dữ liệu theo tháng và năm
        $.ajax({
            url: `/api/bangchamcong/search`, // Đường dẫn đến API để lọc theo tháng và năm
            type: 'GET',
            data: { month: selectedMonth, year: selectedYear }, // Truyền dữ liệu tháng và năm
            success: function (data) {
                if (data.length > 0) {
                    renderTable(data); // Hiển thị bảng với dữ liệu trả về
                } else {
                    const tableBody = document.querySelector('#attendanceTable tbody');
                    tableBody.innerHTML = '<tr><td colspan="10">Không có dữ liệu chấm công cho tháng và năm này.</td></tr>';
                }
            },
            error: function (xhr, status, error) {
                console.error('Error fetching attendance data:', error);
                alert('Có lỗi xảy ra khi lấy dữ liệu.');
            }
        });
    }
}

// Lắng nghe sự kiện thay đổi
$('#selectMonth, #selectYear').on('change', function () {
    filterTableByDate();
});


  function renderTable(data) {
      const tableBody = document.querySelector('#attendanceTable tbody');
      tableBody.innerHTML = ''; // Clear existing rows

      data.forEach(item => {
          const row = document.createElement('tr');
          const date = new Date(item.thoiGian); // Convert the LocalDate string to a Date object
          const formattedDate = `${date.getMonth() + 1}/${date.getFullYear()}`; // Format as MM/YYYY

          // Create row content
          row.innerHTML = `
              <td><input type="text" value="${item.maBangChamCong}" disabled></td>
              <td><input type="text" value="${item.maNhanSu}" disabled></td>
              <td><input type="text" value="${formattedDate}" disabled></td>
              <td><input type="number" value="${item.soNgayLamTrongThang}" disabled></td>
              <td><input type="number" value="${item.soGioLamThem}" disabled></td>
              <td><input type="number" value="${item.soNgayNghiCoPhep}" disabled></td>
              <td><input type="number" value="${item.soNgayNghiKhongPhep}" disabled></td>
              <td><input type="text" value="${item.ghiChu}" disabled></td>
              <td><input type="checkbox" ${item.duocPhepChinhSua ? 'checked' : ''} disabled></td>
              <td>
                  <button class="btn btn-secondary" onclick="enableEditing(this)">Chỉnh sửa</button>
                  <button class="btn btn-primary" onclick="saveData('${item.maBangChamCong}', this)" disabled>Lưu</button>
              </td>
          `;
          tableBody.appendChild(row);
      });
  }

  // Function to enable editing mode
  function enableEditing(button) {
      const row = button.closest('tr');
      const inputs = row.querySelectorAll('input:not([type="checkbox"])'); // Lấy tất cả input (trừ checkbox)
      const saveButton = row.querySelector('button:nth-child(2)'); // Nút Lưu trong dòng
      const checkbox = row.querySelector('input[type="checkbox"]'); // Checkbox chỉnh sửa

      // Bật tất cả các input và checkbox
      inputs.forEach(input => input.disabled = false);
      if (checkbox) checkbox.disabled = false;

      // Bật nút Lưu
      if (saveButton) saveButton.disabled = false;

      // Tắt nút "Chỉnh sửa"
      button.disabled = true;
  }

  // Function to save data after editing
  async function saveData(maBangChamCong, button) {
      const row = button.closest('tr');
      const inputs = row.querySelectorAll('input:not([type="checkbox"])');
      const checkbox = row.querySelector('input[type="checkbox"]');

      const data = {
          maBangChamCong: inputs[0].value,
          maNhanSu: inputs[1].value,
          thoiGian: inputs[2].value,
          soNgayLamTrongThang: parseInt(inputs[3].value) || 0,
          soGioLamThem: parseInt(inputs[4].value) || 0,
          soNgayNghiCoPhep: parseInt(inputs[5].value) || 0,
          soNgayNghiKhongPhep: parseInt(inputs[6].value) || 0,
          ghiChu: inputs[7].value || '',
          duocPhepChinhSua: checkbox ? checkbox.checked : false
      };

      try {
          const response = await fetch(`http://localhost:8080/api/bangchamcong/${maBangChamCong}`, {
              method: 'PUT',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify(data)
          });

          if (response.ok) {
              alert('Cập nhật thành công');

              // Vô hiệu hóa các input sau khi lưu
              inputs.forEach(input => input.disabled = true);
              if (checkbox) checkbox.disabled = true;

              // Bật lại nút "Chỉnh sửa" và tắt nút "Lưu"
              const editButton = row.querySelector('button:nth-child(1)');
              const saveButton = row.querySelector('button:nth-child(2)');
              editButton.disabled = false;
              saveButton.disabled = true;

              fetchBangChamCongData(); // Refresh bảng dữ liệu
          } else {
              alert('Cập nhật thất bại');
          }
      } catch (error) {
          console.error('Error saving data:', error);
      }
  }

  async function fetchBangChamCongData() {
      try {
          const response = await fetch('http://localhost:8080/api/bangchamcong/all');
          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          if (data.length > 0) {
              renderTable(data);
          } else {
              const tableBody = document.querySelector('#attendanceTable tbody');
              tableBody.innerHTML = '<tr><td colspan="8">Không có dữ liệu chấm công.</td></tr>';
          }
      } catch (error) {
          console.error('Error fetching data:', error);
          alert(`Có lỗi xảy ra khi tải dữ liệu: ${error.message}`);
      }
  }

  function downloadExcel() {
      // Gọi API tải xuống file Excel
      fetch('/api/bangchamcong/export/excel', {
          method: 'GET',
          headers: {
              'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
          }
      })
      .then(response => {
          if (!response.ok) {
              throw new Error('Có lỗi xảy ra khi tải file.');
          }
          return response.blob();
      })
      .then(blob => {
          const url = window.URL.createObjectURL(new Blob([blob]));

          if (window.showSaveFilePicker) {
              window.showSaveFilePicker({
                  suggestedName: 'bangchamcong.xlsx',
                  types: [{
                      description: 'Excel Files',
                      accept: {'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']}
                  }]
              }).then(fileHandle => {
                  fileHandle.createWritable().then(writable => {
                      writable.write(blob).then(() => writable.close());
                  });
              }).catch(error => {
                  console.error('Error while saving the file:', error);
                  alert('Không thể lưu file Excel.');
              });
          } else {
              const link = document.createElement('a');
              link.href = url;
              link.setAttribute('download', 'bangchamcong.xlsx');
              document.body.appendChild(link);
              link.click();
              link.remove();
          }
      })
      .catch(error => {
          console.error('Lỗi:', error);
          alert('Không thể tải xuống file Excel.');
      });
  }

  // Call fetchBangChamCongData when the page loads
  window.onload = fetchBangChamCongData;

  async function createAttendanceSheet() {
      try {
          const response = await fetch('http://localhost:8080/api/hoso/all');
          if (response.ok) {
              const employees = await response.json();
              const today = new Date();
              const month = today.getMonth() + 1;
              const year = today.getFullYear();
              const attendanceData = employees.map(employee => ({
                  maBangChamCong: `BCC_${month}${year}_${employee.maNhanSu}`,
                  maNhanSu: employee.maNhanSu,
                  thoiGian: `${year}-${month < 10 ? '0' + month : month}-01`,
                  soNgayLamTrongThang: 0,
                  soGioLamThem: 0,
                  soNgayNghiCoPhep: 0,
                  soNgayNghiKhongPhep: 0,
                  ghiChu: ""
            }));

            // Render the attendance table with fetched data
            renderTable(attendanceData);

            // Save each attendance record to the database
            const savePromises = attendanceData.map(entry =>
                fetch('http://localhost:8080/api/bangchamcong/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry)
                })
            );

            await Promise.all(savePromises);
            alert('Bảng chấm công đã được tạo và lưu thành công');
            fetchBangChamCongData(); // Refresh the table after saving
        } else {
            alert('Không thể tải dữ liệu nhân sự');
        }
    } catch (error) {
        console.error('Error creating attendance table:', error);
    }
}

</script>

<!-- Bootstrap JS (thêm vào nếu cần) -->
<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
</body>
</html>
